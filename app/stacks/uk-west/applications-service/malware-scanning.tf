import {
  to = azurerm_security_center_storage_defender.malware_scanning
  id = azurerm_storage_account.applications_sql_server.id
}

resource "azurerm_security_center_storage_defender" "malware_scanning" {
  storage_account_id = azurerm_storage_account.applications_sql_server.id

  override_subscription_settings_enabled      = true
  malware_scanning_on_upload_enabled          = true
  malware_scanning_on_upload_cap_gb_per_month = 5000
  scan_results_event_grid_topic_id            = azurerm_eventgrid_topic.malware_scanning_topic.id
  sensitive_data_discovery_enabled            = false
}

resource "azurerm_eventgrid_topic" "malware_scanning_topic" {
  #checkov:skip=CKV_AZURE_192: TODO: Ensure that Azure Event Grid Topic local Authentication is disabled
  #checkov:skip=CKV_AZURE_193: TODO: Ensure public network access is disabled for Azure Event Grid Topic
  name                = "malware-scanning-topic-${local.resource_suffix}"
  resource_group_name = azurerm_resource_group.applications_service_stack.name
  location            = azurerm_resource_group.applications_service_stack.location

  identity {
    type = "SystemAssigned"
  }
}
