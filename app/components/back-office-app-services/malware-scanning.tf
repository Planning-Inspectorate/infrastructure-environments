resource "azurerm_resource_group_template_deployment" "malware_scanning" {
  name                = "malware-scanning-deploy"
  resource_group_name = var.resource_group_name
  deployment_mode     = "Incremental"
  template_content    = <<EOT
  {
    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
      "storage_account_name": {
        "type": "string"
      },
      "subscription_id": {
        "type": "string"
      },
      "resource_group": {
        "type": "string"
      },
      "event_grid_topicId": {
        "type": "string"
      },
      "cap_gb_per_month": {
        "type": "int"
      }
    },
    "resources": [
      {
        "type": "Microsoft.Security/DefenderForStorageSettings",
        "apiVersion": "2022-12-01-preview",
        "name": "current",
        "properties": {
          "isEnabled": true,
          "malwareScanning": {
            "onUpload": {
              "isEnabled": true,
              "capGBPerMonth": "[parameters('cap_gb_per_month')]"
            },
            "scanResultsEventGridTopicResourceId": "[parameters('event_grid_topicId')]"
          },
          "sensitiveDataDiscovery": {
            "isEnabled": false
          },
          "overrideSubscriptionLevelSettings": true
        },
        "scope": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storage_account_name'))]"
      }
    ],
    "outputs": {}
  }
  EOT

  parameters_content = jsonencode({
    "storage_account_name" = {
      value = var.document_storage_account_name
    }
    "subscription_id" = {
      value = data.azurerm_subscription.current.id
    }
    "resource_group" = {
      value = var.resource_group_name
    }
    "event_grid_topicId" = {
      value = var.malware_scanning_topic_id
    }
    "cap_gb_per_month" = {
      value = 5000
    }
  })
}
